; ==========================================
; PHP-FPM Configuration Optimized for K8s
; ==========================================

[global]
; Logging
error_log = /proc/self/fd/2
log_level = warning

; Emergency restart threshold
emergency_restart_threshold = 10
emergency_restart_interval = 1m
process_control_timeout = 20s

[www]
; User and group
user = appuser
group = appgroup

; Listen configuration
listen = 127.0.0.1:9000
listen.owner = appuser
listen.group = appgroup
listen.mode = 0660
listen.allowed_clients = 127.0.0.1

; Process Management - CRITICAL FOR K8S
; Dynamic é melhor para containers com recursos limitados
pm = dynamic

; Pool size calculation (baseado em 512MB container)
; Regra: (Memória disponível - overhead) / memory_limit por processo
; 512MB - 64MB = 448MB disponível
; 448MB / 32MB por processo = ~14 processos máximos
pm.max_children = 20
pm.start_servers = 5        ; 25% do max_children
pm.min_spare_servers = 3    ; 15% do max_children  
pm.max_spare_servers = 8    ; 40% do max_children

; Lifecycle management
pm.max_requests = 500       ; Evita memory leaks
pm.process_idle_timeout = 10s

; Monitoring - ESSENCIAL PARA OBSERVABILIDADE
pm.status_path = /status
ping.path = /ping
ping.response = pong

; Logging
access.log = /proc/self/fd/2
access.format = "%R - %u %t \"%m %r\" %s %f %{mili}d %{kilo}M %C%%"

; Timeouts
request_terminate_timeout = 30s
request_slowlog_timeout = 10s
slowlog = /proc/self/fd/2

; Environment variables (important for Laravel)
clear_env = no

; Security
security.limit_extensions = .php .phar
